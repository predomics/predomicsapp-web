# PredomicsApp — Production Docker Compose Override
#
# Usage:
#   cp .env.example .env   # edit with production values
#   ./scripts/ssl-init.sh  # first-time SSL certificate setup
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# This file overrides the base docker-compose.yml with:
#   - NGINX reverse proxy with SSL/TLS
#   - Let's Encrypt certificate auto-renewal
#   - Resource limits on all services
#   - No exposed ports except 80/443
#   - Log rotation
#   - Scheduled database backups

services:
  # --------------------------------------------------------------------------
  # NGINX — reverse proxy with SSL termination
  # --------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: predomics-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      - app
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --------------------------------------------------------------------------
  # Certbot — Let's Encrypt auto-renewal (checks every 12 hours)
  # --------------------------------------------------------------------------
  certbot:
    image: certbot/certbot
    container_name: predomics-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 43200; done'"
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # Database — production overrides
  # --------------------------------------------------------------------------
  db:
    ports: !override []
    environment:
      POSTGRES_USER: predomics
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: predomics
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --------------------------------------------------------------------------
  # Application — production overrides
  # --------------------------------------------------------------------------
  app:
    ports: !override []
    environment:
      - PREDOMICS_DATA_DIR=/app/data
      - PREDOMICS_UPLOAD_DIR=/app/data/uploads
      - PREDOMICS_PROJECT_DIR=/app/data/projects
      - PREDOMICS_SAMPLE_DIR=/app/data/qin2014_cirrhosis
      - PREDOMICS_DATABASE_URL=${PREDOMICS_DATABASE_URL}
      - PREDOMICS_SECRET_KEY=${PREDOMICS_SECRET_KEY}
      - PREDOMICS_CORS_ORIGINS=${PREDOMICS_CORS_ORIGINS}
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

  # --------------------------------------------------------------------------
  # Backup — daily PostgreSQL dump + data volume tar
  # --------------------------------------------------------------------------
  backup:
    image: postgres:16-alpine
    container_name: predomics-backup
    volumes:
      - ./backups:/backups
      - app-data:/app/data:ro
    environment:
      PGHOST: db
      PGUSER: predomics
      PGPASSWORD: ${POSTGRES_PASSWORD}
      PGDATABASE: predomics
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-7}
    entrypoint: >
      /bin/sh -c '
        echo "Backup service started (daily at 02:00 UTC)"
        while true; do
          NEXT=$$(date -d "tomorrow 02:00" +%s 2>/dev/null || date -v+1d -v2H -v0M -v0S +%s 2>/dev/null || echo 0)
          NOW=$$(date +%s)
          if [ "$$NEXT" -gt "$$NOW" ]; then SLEEP=$$((NEXT - NOW)); else SLEEP=86400; fi
          sleep $$SLEEP

          TS=$$(date +%Y%m%d_%H%M%S)
          echo "[$$TS] Starting backup..."

          pg_dump -Fc > /backups/db_$$TS.dump 2>/dev/null && \
            echo "[$$TS] DB dump: ok" || echo "[$$TS] DB dump: FAILED"

          tar czf /backups/data_$$TS.tar.gz -C /app/data . 2>/dev/null && \
            echo "[$$TS] Data tar: ok" || echo "[$$TS] Data tar: FAILED"

          # Retention: remove backups older than N days
          find /backups -name "db_*.dump" -mtime +$$BACKUP_RETENTION_DAYS -delete 2>/dev/null
          find /backups -name "data_*.tar.gz" -mtime +$$BACKUP_RETENTION_DAYS -delete 2>/dev/null
          echo "[$$TS] Cleanup done (retention: $$BACKUP_RETENTION_DAYS days)"
        done
      '
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"
